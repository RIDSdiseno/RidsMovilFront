<ion-header>
  <ion-toolbar class="custom-header-toolbar">
    <ion-title class="header-title">Registro de Visitas</ion-title>
    <ion-buttons slot="end">
      <img src="assets/img/LOGO_RIDS.png" alt="Logo RIDS" style="height: 38px;" class="header-logo" />
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding has-footer-menu">
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ estado }}</ion-card-title> <!-- Mostrar estado actual -->
      <ion-card-subtitle>{{ estadoTexto }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <p><strong>Inicio:</strong> {{ inicio | date:'dd/MM/yyyy HH:mm' }}</p>
      <p><strong>Término:</strong> {{ fin | date:'dd/MM/yyyy HH:mm' }}</p>
      <ion-button expand="block" (click)="iniciarVisita()" [disabled]="visitaEnCurso">Iniciar Visita</ion-button>
      <ion-button expand="block" (click)="terminarVisita()" [disabled]="!visitaEnCurso">Guardar Visita</ion-button>
      <ion-button expand="block" fill="outline" (click)="resetFormulario()">Limpiar Datos de Visita</ion-button>
  <ion-button color="medium" expand="block" (click)="refrescarUsuarios()">
  <ion-icon name="refresh"></ion-icon>
  Actualizar Usuarios
</ion-button>


    </ion-card-content>
  </ion-card>


  <!-- Formulario -->
  <form [formGroup]="visitaForm">
    <!-- Datos principales -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Datos principales</ion-card-title>
      </ion-card-header>
      <ion-card-content>

        <!-- Cliente -->
        <ion-item>
          <ion-label position="stacked">Empresa / Cliente</ion-label>
          <ion-select formControlName="cliente" placeholder="Selecciona un cliente" interface="popover">
            <ion-select-option *ngFor="let cliente of clientes" [value]="cliente.id_empresa">
              {{ cliente.nombre }}
            </ion-select-option>
          </ion-select>
        </ion-item>
        <ion-note color="danger" *ngIf="visitaForm.get('cliente')?.invalid && visitaForm.get('cliente')?.touched">
          Este campo es obligatorio.
        </ion-note>


        <!-- SUCURSAL (solo si existen) -->
        <ion-item *ngIf="tieneSucursales">
          <ion-label position="stacked">Sucursal</ion-label>
          <ion-select formControlName="sucursal" placeholder="Selecciona una sucursal">
            <ion-select-option *ngFor="let s of sucursales" [value]="s.id_sucursal">
              {{ s.nombre }} - {{ s.direccion }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Selector de Solicitantes - Diseño Mejorado -->
        <div *ngIf="visitaForm.get('cliente')?.value && (!tieneSucursales || visitaForm.get('sucursal')?.value)">

          <ion-item lines="none" class="solicitante-item">
            <ion-label position="stacked" class="input-label">
              <div class="label-header">
                <span>Solicitantes</span>
                <span class="counter" [class.has-selection]="visitaForm.value.solicitante?.length > 0">
                  seleccionados {{ visitaForm.value.solicitante?.length || 0 }}
                </span>
              </div>
            </ion-label>

            <div class="selector-trigger" (click)="abrirListaSolicitantes()"
              [class.has-selection]="visitaForm.value.solicitante?.length > 0">
              <div class="trigger-content">
                <br>
                <ion-icon name="person-outline" class="trigger-icon"></ion-icon>
                <span class="trigger-text">
                  {{ visitaForm.value.solicitante?.length > 0 ? 'Ver seleccionados' : 'Seleccionar solicitantes' }}
                </span>
                <ion-icon [name]="mostrarListaSolicitantes ? 'chevron-up' : 'chevron-down'"
                  class="trigger-arrow"></ion-icon>
              </div>
            </div>
          </ion-item>

          <!-- Chips de selección (siempre visibles cuando hay selección) -->
          <div *ngIf="visitaForm.value.solicitante?.length > 0" class="chips-section">
            <div class="chips-container">
              <ion-chip *ngFor="let s of visitaForm.value.solicitante" color="primary" class="selection-chip">
                <ion-avatar *ngIf="s.iniciales" class="avatar-chip">
                  <span>{{ s.iniciales }}</span>
                </ion-avatar>
                <ion-label>{{ s.nombre }}</ion-label>
                <ion-icon name="close-circle" (click)="eliminarSolicitante(s)" class="remove-icon"></ion-icon>
              </ion-chip>
            </div>
          </div>

          <!-- Panel de selección desplegable -->
          <ion-card *ngIf="mostrarListaSolicitantes" class="dropdown-card modern-dropdown open">
            <div class="dropdown-header">
              <ion-button fill="clear" size="small" (click)="mostrarListaSolicitantes = false" class="close-btn">
                <ion-icon name="close"></ion-icon>
              </ion-button>
            </div>

            <!-- Barra de búsqueda mejorada -->
            <div class="search-section">
              <ion-searchbar class="searchbar-solicitante" placeholder="Buscar solicitantes..."
                formControlName="busquedaSolicitante" debounce="300" (ionInput)="filtrarSolicitantes()" animated>
              </ion-searchbar>
              <div class="search-stats" *ngIf="filtradosSolicitantes.length > 0">
                {{ filtradosSolicitantes.length }} resultado{{ filtradosSolicitantes.length !== 1 ? 's' : '' }}
              </div>
            </div>

            <!-- Lista de solicitantes mejorada -->
            <ion-list class="lista-solicitantes modern-list" lines="none">
              <ion-item *ngFor="let s of filtradosSolicitantes" button (click)="seleccionarSolicitante(s)"
                [class.selected]="esSolicitanteSeleccionado(s)" class="solicitante-item-list">

                <!-- Información del solicitante -->
                <ion-label class="solicitante-info">
                  <h3>{{ s.nombre }}</h3>
                </ion-label>

                <!-- Estado de selección -->
                <div slot="end" class="selection-indicator">
                  <ion-icon [name]="esSolicitanteSeleccionado(s) ? 'checkmark-circle' : 'ellipse-outline'"
                    [color]="esSolicitanteSeleccionado(s) ? 'primary' : 'medium'" class="check-icon">
                  </ion-icon>
                </div>
              </ion-item>

              <!-- Estado vacío -->
              <ion-item *ngIf="filtradosSolicitantes.length === 0" class="empty-state">
                <ion-icon name="search-outline" slot="start" color="medium"></ion-icon>
                <ion-label color="medium">
                  <h3>No se encontraron solicitantes</h3>
                  <p>Intenta con otros términos de búsqueda</p>
                </ion-label>
              </ion-item>
            </ion-list>

            <!-- Footer del dropdown -->
            <div class="dropdown-footer">
              <ion-button fill="solid" color="primary" (click)="mostrarListaSolicitantes = false" class="done-btn">
                <ion-icon name="checkmark" slot="start"></ion-icon>
                Listo
              </ion-button>
            </div>
          </ion-card>

          <!-- Mensaje de error -->
          <ion-note color="danger" class="error-note"
            *ngIf="visitaForm.get('solicitante')?.invalid && visitaForm.get('solicitante')?.touched">
            <ion-icon name="warning" slot="start"></ion-icon>
            Debes seleccionar al menos un solicitante
          </ion-note>
        </div>

      </ion-card-content>
    </ion-card>

    <!-- Solicitud adicional -->
    <ion-card [formGroupName]="'actividades'">
      <ion-card-header>
        <ion-card-title>Solicitud adicional</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label class="nowrap">Conf. impresoras</ion-label>
          <ion-checkbox slot="end" formControlName="impresoras"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Conf. teléfonos IP</ion-label>
          <ion-checkbox slot="end" formControlName="telefonos"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Conf. pie de página</ion-label>
          <ion-checkbox slot="end" formControlName="pie"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Otra Solicitud...</ion-label>
          <ion-checkbox slot="end" formControlName="otros"></ion-checkbox>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Campo "otrosDetalle" solo si "otros" está activo -->
    <ion-item *ngIf="visitaForm.get('actividades.otros')?.value">
      <ion-label position="stacked">Detalle de otros servicios</ion-label>
      <br>
      <ion-textarea formControlName="otrosDetalle" placeholder="Describe los otros servicios realizados..."
        [autoGrow]="true" rows="3" maxlength="500" counter="true" class="expandable-textarea"></ion-textarea>
    </ion-item>

    <!-- Lo realizado -->
    <ion-card [formGroupName]="'actividades'">
      <ion-card-header>
        <ion-card-title>Lo realizado</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <!-- Nueva sección para seleccionar las actividades realizadas -->
        <ion-item>
          <ion-label class="nowrap">Conf. CCleaner</ion-label>
          <ion-checkbox slot="end" formControlName="ccleaner"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Conf. Actualizaciones</ion-label>
          <ion-checkbox slot="end" formControlName="actualizaciones"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Conf. Antivirus</ion-label>
          <ion-checkbox slot="end" formControlName="antivirus"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Conf. Estado de Disco</ion-label>
          <ion-checkbox slot="end" formControlName="estadoDisco"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap" l>Licencia Windows</ion-label>
          <ion-checkbox slot="end" formControlName="licenciaWindows"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Licencia Office</ion-label>
          <ion-checkbox slot="end" formControlName="licenciaOffice"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Rendimiento del equipo</ion-label>
          <ion-checkbox slot="end" formControlName="rendimientoEquipo"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Mantenimiento de reloj</ion-label>
          <ion-checkbox slot="end" formControlName="mantenimientoReloj"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Ecógrafo</ion-label>
          <ion-checkbox slot="end" formControlName="ecografo"></ion-checkbox>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <ion-card class="address-card">
      <ion-card-header>
        <ion-card-title class="card-title">
          <ion-icon name="location-outline" aria-hidden="true"></ion-icon>
          Dirección de la visita
        </ion-card-title>
        <ion-card-subtitle>
          <ion-icon name="information-circle-outline"></ion-icon>
          La ubicación se registra automáticamente al guardar/finalizar la visita
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content class="card-content">
        <div class="address-display-container">
          <ion-input [value]="direccionExacta" readonly
            [placeholder]="isLoadingLocation ? 'Obteniendo ubicación...' : 'Ubicación no disponible'"
            class="address-display">
          </ion-input>
        </div>
      </ion-card-content>
    </ion-card>

  </form>

</ion-content>

<app-footer-menu></app-footer-menu>

<ion-header>
  <ion-toolbar class="custom-header-toolbar">
    <ion-title class="header-title">Registro de Visitas</ion-title>
    <ion-buttons slot="end">
      <img src="assets/img/LOGO_RIDS.png" alt="Logo RIDS" style="height: 38px;" class="header-logo" />
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Estado -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ estado }}</ion-card-title> <!-- Mostrar estado actual -->
      <ion-card-subtitle>{{ estadoTexto }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <p><strong>Inicio:</strong> {{ inicio | date:'dd/MM/yyyy HH:mm' }}</p>
      <p><strong>Término:</strong> {{ fin | date:'dd/MM/yyyy HH:mm' }}</p>
      <ion-button expand="block" (click)="iniciarVisita()" [disabled]="visitaEnCurso">Iniciar Visita</ion-button>
      <ion-button expand="block" (click)="terminarVisita()" [disabled]="!visitaEnCurso">Terminar Visita</ion-button>
      <ion-button expand="block" fill="outline" (click)="resetFormulario()">Limpiar Datos de Visita</ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Formulario -->
  <form [formGroup]="visitaForm">
    <!-- Datos principales -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Datos principales</ion-card-title>
      </ion-card-header>
      <ion-card-content>

        <!-- Cliente -->
        <ion-item>
          <ion-label position="stacked">Empresa/Cliente</ion-label>
          <ion-select formControlName="cliente" placeholder="Selecciona un cliente">
            <ion-select-option *ngFor="let cliente of clientes" [value]="cliente.id">
              {{ cliente.nombre }}
            </ion-select-option>
          </ion-select>
        </ion-item>
        <ion-note color="danger" *ngIf="visitaForm.get('cliente')?.invalid && visitaForm.get('cliente')?.touched">
          Este campo es obligatorio.
        </ion-note>

        <!-- Solicitante -->
        <!-- Solicitante -->

<ion-item (click)="abrirListaSolicitantes()">
  <ion-label position="stacked">Solicitante</ion-label>
  <ion-input
    formControlName="solicitante"
    [value]="nombreSolicitanteSeleccionado"
    placeholder="Selecciona solicitante"
    readonly
  ></ion-input>
</ion-item>

<!-- Lista desplegable debajo del input -->
<ion-card *ngIf="mostrarListaSolicitantes" class="dropdown-card">
  <ion-searchbar
  formControlName="busquedaSolicitante"
  (ionInput)="filtrarSolicitantes()"
  placeholder="Buscar solicitante..."
></ion-searchbar>

  <ion-list>
    <ion-item
      button
      *ngFor="let s of filtradosSolicitantes"
      (click)="seleccionarSolicitante(s)"
    >
      {{ s.nombre }}
    </ion-item>
  </ion-list>
</ion-card>

<ion-note color="danger"
  *ngIf="visitaForm.get('solicitante')?.invalid && visitaForm.get('solicitante')?.touched">
  Este campo es obligatorio.
</ion-note>

      </ion-card-content>
    </ion-card>

    <!-- Solicitud adicional -->
    <ion-card [formGroupName]="'actividades'">
      <ion-card-header>
        <ion-card-title>Solicitud adicional</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label class="nowrap">Conf. impresoras</ion-label>
          <ion-checkbox slot="end" formControlName="impresoras"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Conf. teléfonos IP</ion-label>
          <ion-checkbox slot="end" formControlName="telefonos"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Conf. pie de página</ion-label>
          <ion-checkbox slot="end" formControlName="pie"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Otra Solicitud...</ion-label>
          <ion-checkbox slot="end" formControlName="otros"></ion-checkbox>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Campo "otrosDetalle" solo si "otros" está activo -->
    <ion-card *ngIf="visitaForm.get('actividades.otros')?.value">
      <ion-card-content>
        <ion-item>
          <ion-input placeholder="Describe la solicitud" formControlName="otrosDetalle"></ion-input>
        </ion-item>
        <ion-note color="danger"
          *ngIf="visitaForm.get('otrosDetalle')?.invalid && visitaForm.get('otrosDetalle')?.touched">
          Este campo es obligatorio.
        </ion-note>
      </ion-card-content>
    </ion-card>

    <!-- Lo realizado -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Lo realizado</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-textarea formControlName="realizado" rows="4"
          placeholder="Describe las tareas realizadas..."></ion-textarea>

        <!-- Validaciones -->
        <ion-note color="danger"
          *ngIf="visitaForm.get('realizado')?.hasError('required') && (visitaForm.get('realizado')?.touched || visitaForm.get('realizado')?.dirty)">
          Este campo es obligatorio.
        </ion-note>
        <ion-note color="danger"
          *ngIf="visitaForm.get('realizado')?.hasError('minWordsOrChars') && (visitaForm.get('realizado')?.touched || visitaForm.get('realizado')?.dirty)">
          Debes detallar más (mínimo de palabras y caracteres).
        </ion-note>
      </ion-card-content>
    </ion-card>
  </form>
  
</ion-content>

<app-footer-menu></app-footer-menu>
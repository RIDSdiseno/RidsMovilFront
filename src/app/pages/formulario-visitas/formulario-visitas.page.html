<ion-header>
  <ion-toolbar class="custom-header-toolbar">
    <ion-title class="header-title">Registro de Visitas</ion-title>
    <ion-buttons slot="end">
      <img src="assets/img/LOGO_RIDS.png" alt="Logo RIDS" style="height: 38px;" class="header-logo" />
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Estado -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ estado }}</ion-card-title> <!-- Mostrar estado actual -->
      <ion-card-subtitle>{{ estadoTexto }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <p><strong>Inicio:</strong> {{ inicio | date:'dd/MM/yyyy HH:mm' }}</p>
      <p><strong>Término:</strong> {{ fin | date:'dd/MM/yyyy HH:mm' }}</p>
      <ion-button expand="block" (click)="iniciarVisita()" [disabled]="visitaEnCurso">Iniciar Visita</ion-button>
      <ion-button expand="block" (click)="terminarVisita()" [disabled]="!visitaEnCurso">Terminar Visita</ion-button>
      <ion-button expand="block" fill="outline" (click)="resetFormulario()">Limpiar Datos de Visita</ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Formulario -->
  <form [formGroup]="visitaForm">
    <!-- Datos principales -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Datos principales</ion-card-title>
      </ion-card-header>
      <ion-card-content>

        <!-- Cliente -->
        <ion-item>
          <ion-label position="stacked">Empresa / Cliente</ion-label>
          <ion-select formControlName="cliente" placeholder="Selecciona un cliente" interface="popover"
            (ionChange)="abrirListaSolicitantes()">
            <ion-select-option *ngFor="let cliente of clientes" [value]="cliente.id_empresa">
              {{ cliente.nombre }}
            </ion-select-option>
          </ion-select>
        </ion-item>
        <ion-note color="danger" *ngIf="visitaForm.get('cliente')?.invalid && visitaForm.get('cliente')?.touched">
          Este campo es obligatorio.
        </ion-note>

        <!-- Solicitante con dropdown moderno -->
        <ion-item lines="none" class="solicitante-item">
          <ion-label position="stacked" class="input-label">Solicitante</ion-label>
          <ion-input formControlName="solicitante" readonly [value]="nombreSolicitanteSeleccionado"
            (click)="abrirListaSolicitantes()" class="input-solicitante" placeholder="Selecciona un solicitante...">
          </ion-input>
        </ion-item>

        <!-- Solo se muestra cuando está activo -->
        <ion-card *ngIf="mostrarListaSolicitantes" class="dropdown-card">

          <!-- Barra de búsqueda (ya NO dentro del ion-input) -->
          <ion-searchbar class="searchbar-solicitante" placeholder="Buscar por nombre..."
            formControlName="busquedaSolicitante" debounce="300" (ionInput)="filtrarSolicitantes()">
          </ion-searchbar>

          <!-- Lista de solicitantes -->
          <ion-list class="lista-solicitantes">
            <ion-item button *ngFor="let s of filtradosSolicitantes" (click)="seleccionarSolicitante(s)">
              <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
              <ion-label>{{ s.nombre }}</ion-label>
            </ion-item>
            <ion-item *ngIf="filtradosSolicitantes.length === 0">
              <ion-label color="medium">No se encontraron resultados</ion-label>
            </ion-item>
          </ion-list>
        </ion-card>

        <ion-note color="danger"
          *ngIf="visitaForm.get('solicitante')?.invalid && visitaForm.get('solicitante')?.touched">
          Este campo es obligatorio.
        </ion-note>

      </ion-card-content>
    </ion-card>

    <!-- Solicitud adicional -->
    <ion-card [formGroupName]="'actividades'">
      <ion-card-header>
        <ion-card-title>Solicitud adicional</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label class="nowrap">Conf. impresoras</ion-label>
          <ion-checkbox slot="end" formControlName="impresoras"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Conf. teléfonos IP</ion-label>
          <ion-checkbox slot="end" formControlName="telefonos"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Conf. pie de página</ion-label>
          <ion-checkbox slot="end" formControlName="pie"></ion-checkbox>
        </ion-item>
        <ion-item>
          <ion-label class="nowrap">Otra Solicitud...</ion-label>
          <ion-checkbox slot="end" formControlName="otros"></ion-checkbox>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Campo "otrosDetalle" solo si "otros" está activo -->
    <ion-card *ngIf="visitaForm.get('actividades.otros')?.value">
      <ion-card-content>
        <ion-item>
          <ion-input placeholder="Describe la solicitud" formControlName="otrosDetalle"></ion-input>
        </ion-item>
        <ion-note color="danger"
          *ngIf="visitaForm.get('otrosDetalle')?.invalid && visitaForm.get('otrosDetalle')?.touched">
          Este campo es obligatorio.
        </ion-note>
      </ion-card-content>
    </ion-card>

    <!-- Lo realizado -->
<ion-card [formGroupName]="'actividades'">
  <ion-card-header>
    <ion-card-title>Lo realizado</ion-card-title>
  </ion-card-header>
  <ion-card-content>
    <!-- Nueva sección para seleccionar las actividades realizadas -->
    <ion-item>
      <ion-label class="nowrap">Conf. CCleaner</ion-label>
      <ion-checkbox slot="end" formControlName="ccleaner"></ion-checkbox>
    </ion-item>
    <ion-item>
      <ion-label class="nowrap">Conf. Actualizaciones</ion-label>
      <ion-checkbox slot="end" formControlName="actualizaciones"></ion-checkbox>
    </ion-item>
    <ion-item>
      <ion-label class="nowrap">Conf. Antivirus</ion-label>
      <ion-checkbox slot="end" formControlName="antivirus"></ion-checkbox>
    </ion-item>
    <ion-item>
      <ion-label class="nowrap">Conf. Estado de Disco</ion-label>
      <ion-checkbox slot="end" formControlName="estadoDisco"></ion-checkbox>
    </ion-item>
    <ion-item>
      <ion-label class="nowrap"l>Licencia Windows</ion-label>
      <ion-checkbox slot="end" formControlName="licenciaWindows"></ion-checkbox>
    </ion-item>
    <ion-item>
      <ion-label class="nowrap">Licencia Office</ion-label>
      <ion-checkbox slot="end" formControlName="licenciaOffice"></ion-checkbox>
    </ion-item>
    <ion-item>
      <ion-label class="nowrap">Rendimiento del equipo</ion-label>
      <ion-checkbox slot="end" formControlName="rendimientoEquipo"></ion-checkbox>
    </ion-item>
    <ion-item>
      <ion-label class="nowrap">Mantenimiento de reloj</ion-label>
      <ion-checkbox slot="end" formControlName="mantenimientoReloj"></ion-checkbox>
    </ion-item>
  </ion-card-content>
</ion-card>

  </form>

</ion-content>

<app-footer-menu></app-footer-menu>
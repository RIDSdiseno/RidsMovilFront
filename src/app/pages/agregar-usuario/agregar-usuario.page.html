<ion-header>
  <ion-toolbar class="custom-header-toolbar">
    <ion-title class="header-title">Sincronizar Usuarios</ion-title>
    <ion-buttons slot="end">
      <img src="assets/img/LOGO_RIDS.png" alt="Logo RIDS" class="header-logo" />
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding main-content has-footer-menu">
  <div class="content-wrapper">
    <!-- Card Principal: selección de cliente/empresa -->
    <ion-card class="selection-card">
      <ion-card-header class="card-header">
        <ion-card-title class="card-title">
          <ion-icon name="business" class="title-icon"></ion-icon>
          Selección de Empresa / Cliente
        </ion-card-title>
      </ion-card-header>

      <ion-card-content class="card-content">
        <form [formGroup]="usuarioForm">
          <!-- Cliente -->
          <div class="form-section">
            <ion-item class="form-item custom-item" lines="none">
              <ion-label position="stacked" class="form-label">
                <ion-icon name="business-outline" class="label-icon"></ion-icon>
                Cliente / Empresa *
              </ion-label>
              <ion-select
                formControlName="cliente"
                placeholder="Selecciona una empresa..."
                interface="action-sheet"
                class="custom-select"
              >
                <ion-select-option
                  *ngFor="let cliente of clientes"
                  [value]="cliente.id_empresa"
                >
                  {{ cliente.nombre }}
                </ion-select-option>
              </ion-select>
              <ion-note
                *ngIf="usuarioForm.get('cliente')?.invalid && usuarioForm.get('cliente')?.touched"
                class="error-note"
              >
                <ion-icon name="warning-outline"></ion-icon>
                Selecciona un cliente
              </ion-note>
            </ion-item>
          </div>

          <!-- Información de cliente seleccionado -->
          <div *ngIf="usuarioForm.get('cliente')?.value" class="chips-container">
            <div class="selected-cliente-card">
              <div class="cliente-header">
                <h4 class="cliente-title">Cliente seleccionado:</h4>
                <ion-badge color="primary" class="selection-badge">
                  <ion-icon name="checkmark-circle"></ion-icon>
                  Listo para sincronizar usuarios
                </ion-badge>
              </div>
              <ion-chip class="custom-chip selected-chip" color="primary">
                <ion-avatar class="chip-avatar">
                  <ion-icon name="business-outline"></ion-icon>
                </ion-avatar>
                <ion-label class="chip-label">
                  <strong>{{ getClienteSeleccionadoNombre() }}</strong>
                </ion-label>
              </ion-chip>

              <p class="helper-text">
                Ahora puedes configurar los parámetros de sincronización para este cliente
                en la tarjeta inferior.
              </p>
            </div>
          </div>

          <!-- Estado de carga -->
          <div *ngIf="cargandoClientes" class="loading-container">
            <ion-item class="loading-item">
              <ion-spinner slot="start" name="crescent"></ion-spinner>
              <ion-label>Cargando clientes...</ion-label>
            </ion-item>
          </div>
        </form>
      </ion-card-content>
    </ion-card>

    <!-- Card de sincronización (Google / Microsoft) -->
    <ion-card
      *ngIf="usuarioForm.get('cliente')?.value"
      class="usuario-form-card floating-card"
    >
      <ion-card-header class="card-header success-header">
        <ion-card-title class="card-title">
          <ion-icon name="sync-outline" class="title-icon"></ion-icon>
          Sincronizar usuarios para {{ getClienteSeleccionadoNombre() }}
        </ion-card-title>
        <ion-card-subtitle class="card-subtitle">
          Define el dominio y, opcionalmente, un email para sincronizar solo un usuario.
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content class="card-content">
        <form [formGroup]="usuarioForm">
          <div class="form-grid">
            <!-- Parámetros de sincronización -->
            <div class="form-section required-section">
              <h4 class="section-title">
                <ion-icon name="globe-outline" class="section-icon"></ion-icon>
                Parámetros de sincronización
              </h4>

              <!-- Dominio -->
              <ion-item class="form-item custom-item" lines="none">
                <ion-label position="stacked" class="form-label required">
                  <ion-icon name="at-outline" class="label-icon"></ion-icon>
                  Dominio (ej: colegio.cl) *
                </ion-label>
                <ion-input
                  formControlName="domain"
                  placeholder="ej: colegio.cl"
                  class="custom-input"
                  clearInput
                >
                </ion-input>
              </ion-item>
              <ion-note
                *ngIf="usuarioForm.get('domain')?.touched && usuarioForm.get('domain')?.invalid"
                class="error-note"
              >
                <ion-icon name="warning-outline"></ion-icon>
                El dominio es requerido
              </ion-note>

              <!-- Email opcional -->
              <ion-item class="form-item custom-item" lines="none">
                <ion-label position="stacked" class="form-label">
                  <ion-icon name="mail-outline" class="label-icon"></ion-icon>
                  Email (opcional, para sincronizar solo un usuario)
                </ion-label>
                <ion-input
                  formControlName="email"
                  placeholder="usuario@colegio.cl"
                  type="email"
                  class="custom-input"
                  clearInput
                  [class]="!validarEmail() ? 'ion-invalid' : ''"
                >
                </ion-input>
              </ion-item>
              <ion-note *ngIf="!validarEmail()" class="error-note">
                <ion-icon name="warning-outline"></ion-icon>
                Formato de email inválido
              </ion-note>
            </div>
          </div>

          <!-- Botones de acción -->
          <div class="actions-container">
            <ion-button
              expand="block"
              color="primary"
              (click)="syncGoogle()"
              [disabled]="
                sincronizando ||
                usuarioForm.get('cliente')?.invalid ||
                usuarioForm.get('domain')?.invalid ||
                !validarEmail()
              "
              class="action-button primary-button"
            >
              <ion-icon name="logo-google" slot="start"></ion-icon>
              Sincronizar desde Google Workspace
            </ion-button>

            <ion-button
              expand="block"
              color="secondary"
              (click)="syncMicrosoft()"
              [disabled]="
                sincronizando ||
                usuarioForm.get('cliente')?.invalid ||
                !validarEmail()
              "
              class="action-button outline-button"
            >
              <ion-icon name="logo-microsoft" slot="start"></ion-icon>
              Sincronizar desde Microsoft 365
            </ion-button>
          </div>

          <!-- Estado de sincronización -->
          <div *ngIf="sincronizando" class="loading-container">
            <ion-item class="loading-item">
              <ion-spinner slot="start" name="crescent"></ion-spinner>
              <ion-label>Ejecutando sincronización...</ion-label>
            </ion-item>
          </div>

          <!-- Resumen de la última sincronización -->
          <div class="summary-card" *ngIf="resultadoSync">
            <ion-card class="preview-card">
              <ion-card-header>
                <ion-card-title>Resultado de la última sincronización</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <div class="summary-content">
                  <div class="summary-item">
                    <strong>Origen:</strong> {{ resultadoSync.origen }}
                  </div>
                  <div class="summary-item">
                    <strong>Dominio:</strong> {{ resultadoSync.domain || '—' }}
                  </div>
                  <div class="summary-item" *ngIf="resultadoSync.filter">
                    <strong>Filtro (email):</strong> {{ resultadoSync.filter }}
                  </div>
                  <div class="summary-item">
                    <strong>Total procesados:</strong> {{ resultadoSync.total }}
                  </div>
                  <div class="summary-item">
                    <strong>Creados:</strong> {{ resultadoSync.created }}
                  </div>
                  <div class="summary-item">
                    <strong>Actualizados:</strong> {{ resultadoSync.updated }}
                  </div>
                  <div class="summary-item">
                    <strong>Omitidos:</strong> {{ resultadoSync.skipped }}
                  </div>
                </div>
              </ion-card-content>
            </ion-card>
          </div>
        </form>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>

<app-footer-menu></app-footer-menu>
